// Modal and Table Management
document.getElementById("addButton").onclick = function() {
    document.getElementById("addShipmentFormModal").style.display = "block";
};

document.querySelector(".close").onclick = function() {
    document.getElementById("addShipmentFormModal").style.display = "none";
};

document.querySelector(".close-notification").onclick = function() {
    document.getElementById("notificationModal").style.display = "none";
};

document.getElementById("addLineButton").onclick = function() {
    addLine();
};

document.getElementById("cancelLineButton").onclick = function() {
    clearLineInputs();
};

document.getElementById("addShipmentForm").onsubmit = function(event) {
    event.preventDefault(); // Prevent form submission
    submitShipment();
};

let currentEditRow = null; // Track the row being edited

// Add or update a line in the shipment
function addLine() {
    const productId = document.getElementById("product_id").value;
    const quantity = document.getElementById("quantity").value;

    // Validation: Check for empty fields
    if (!productId || !quantity) {
        showNotification("Please fill in both product ID and quantity.");
        return;
    }

    const lineTable = document.getElementById("lineTable").getElementsByTagName("tbody")[0];

    if (currentEditRow) {
        // If editing a row, update it
        currentEditRow.cells[0].innerText = productId;
        currentEditRow.cells[1].innerText = quantity;
        currentEditRow = null;
        document.getElementById("addLineButton").innerText = "Add Line"; // Reset button text
    } else {
        // Otherwise, add a new row
        const newRow = lineTable.insertRow();
        newRow.insertCell(0).innerText = productId;
        newRow.insertCell(1).innerText = quantity;

        // Create Edit and Delete buttons
        const actionCell = newRow.insertCell(2);
        const editButton = createButton('edit-btn', '<i class="fas fa-edit"></i>', function() { editLine(newRow); });
        const deleteButton = createButton('delete-btn', '<i class="fas fa-trash"></i>', function() { deleteShipmentLine(newRow); });
        actionCell.appendChild(editButton);
        actionCell.appendChild(deleteButton);
    }

    clearLineInputs(); // Clear form after adding/updating
}

// Helper function to create buttons with given classes and actions
function createButton(className, iconHtml, clickHandler) {
    const button = document.createElement("button");
    button.className = `action-btn ${className}`;
    button.innerHTML = iconHtml;
    button.onclick = clickHandler;
    return button;
}

// Edit a selected line
function editLine(row) {
    currentEditRow = row;
    document.getElementById("product_id").value = row.cells[0].innerText;
    document.getElementById("quantity").value = row.cells[1].innerText;
    document.getElementById("addLineButton").innerText = "Update Line";
}

// Delete a selected line
function deleteShipmentLine(row) {
    const lineTable = document.getElementById("lineTable").getElementsByTagName("tbody")[0];
    lineTable.deleteRow(row.rowIndex - 1);
    if (!currentEditRow) {
        document.getElementById("addLineButton").innerText = "Add Line"; // Reset button text if not editing
    }
}

// Clear inputs
function clearLineInputs() {
    document.getElementById("product_id").value = '';
    document.getElementById("quantity").value = '';
}

// Delete Confirmation Modal Logic
document.getElementById("deleteButton").onclick = function() {
    enableRowSelection();
};

function enableRowSelection() {
    const rows = document.getElementById("combinedTable").getElementsByTagName("tbody")[0].rows;

    for (let row of rows) {
        if (!row.cells[0].querySelector('input[type="checkbox"]')) {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            row.cells[0].appendChild(checkbox);
        }
    }

    // Add 'Select All' checkbox functionality
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    selectAllCheckbox.onchange = function() {
        for (let row of rows) {
            const checkbox = row.cells[0].querySelector('input[type="checkbox"]');
            checkbox.checked = selectAllCheckbox.checked;
        }
    };

    document.getElementById("confirmDeleteButton").onclick = function() {
        confirmDeletion(rows);
    };
}

// Confirm deletion of selected rows
function confirmDeletion(rows) {
    const selectedRows = [];
    let deleteMessage = "The following rows will be deleted:<br>";

    for (let row of rows) {
        const checkbox = row.cells[0].querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const documentNo = row.cells[1].innerText;
            const customerNo = row.cells[3].innerText;
            deleteMessage += `Document No: ${documentNo}, Customer No: ${customerNo}<br>`;
            selectedRows.push(row);
        }
    }

    if (selectedRows.length > 0) {
        document.getElementById("deleteConfirmationMessage").innerHTML = deleteMessage;
        document.getElementById("deleteConfirmationModal").style.display = "block";

        document.getElementById("confirmDeleteButton").onclick = function() {
            performDeletion(selectedRows);
            document.getElementById("deleteConfirmationModal").style.display = "none";
        };
    } else {
        showNotification("Please select at least one row to delete.");
    }
    console.log("Checkbox added to row:", row);

    console.log("Selected rows for deletion:", selectedRows);

}

// Delete selected rows
function performDeletion(selectedRows) {
    const tableBody = document.getElementById("combinedTable").getElementsByTagName("tbody")[0];
    selectedRows.forEach(row => tableBody.deleteRow(row.rowIndex - 1));
    showNotification("Selected rows have been deleted.");
}

// Submit the shipment form
function submitShipment() {
    const documentNo = document.getElementById("document_no").value;
    const documentDate = document.getElementById("document_date").value;
    const customerId = document.getElementById("customer_id").value;

    const lineTable = document.getElementById("lineTable").getElementsByTagName("tbody")[0];
    const lineRows = lineTable.rows;

    if (lineRows.length === 0) {
        showNotification("Please add at least one product line.");
        return;
    }

    const combinedTable = document.getElementById("combinedTable").getElementsByTagName("tbody")[0];

    for (let row of lineRows) {
        const productId = row.cells[0].innerText;
        const quantity = row.cells[1].innerText;

        const newRow = combinedTable.insertRow();
        newRow.insertCell(0).innerHTML = `<input type="checkbox">`; // Checkbox for selection
        newRow.insertCell(1).innerText = documentNo;
        newRow.insertCell(2).innerText = documentDate;
        newRow.insertCell(3).innerText = customerId;
        newRow.insertCell(4).innerText = productId;
        newRow.insertCell(5).innerText = quantity;
        newRow.insertCell(6).innerText = "Admin"; // Created By
        newRow.insertCell(7).innerText = "Admin"; // Updated By
		
		const actionCell = newRow.insertCell(8);
		const viewButton = createButton('view-btn', '<i class="fas fa-eye"></i>', function() { viewShipment(newRow); });
		const deleteButton = createButton('delete-btn', '<i class="fas fa-trash"></i>', function() { deleteShipmentRow(newRow); });
		actionCell.appendChild(viewButton);
		actionCell.appendChild(deleteButton);

    }

    // Reset the form and close modal
    document.getElementById("addShipmentForm").reset();
    clearLineInputs();
    document.getElementById("addShipmentFormModal").style.display = "none";
}

// Show notification messages
function showNotification(message) {
    const notificationModal = document.getElementById("notificationModal");
    const notificationMessage = document.getElementById("notificationMessage");
    notificationMessage.innerText = message;
    notificationModal.style.display = "block";
}
